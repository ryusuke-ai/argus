%% Argus Message Flow - Sequence Diagram
%% Shows the complete lifecycle of a Slack message through the system

sequenceDiagram
    participant User
    participant Slack
    participant Bot as Slack Bot
    participant SM as Session Manager
    participant AC as Agent Core
    participant SDK as Claude SDK
    participant MCP as MCP Server
    participant DB as PostgreSQL

    User->>Slack: Send message
    Slack->>Bot: Socket Mode event

    Note over Bot: Route by channel:<br/>inbox / sns / deep-research / default

    Bot->>SM: getOrCreateSession(channel, threadTs)
    SM->>DB: Find or create session
    DB-->>SM: Session record

    Note over SM: Load recent lessons<br/>(episodic memory)
    SM->>DB: Query lessons table
    DB-->>SM: Past error patterns + resolutions

    SM->>AC: query() or resume(sessionId)
    AC->>SDK: Start AsyncGenerator stream

    rect rgb(240, 248, 255)
        Note over SDK,MCP: Tool Execution Loop
        loop Each tool invocation
            SDK->>MCP: Execute tool (knowledge, gmail, etc.)
            MCP-->>SDK: Tool result
            SDK->>AC: SDKAssistantMessage
            Note over AC,DB: Hooks fire on every tool call
            AC->>DB: Record tool execution<br/>(PreToolUse â†’ PostToolUse)
            AC-->>SM: Progress notification (throttled)
            SM-->>Bot: Update Slack thread
        end
    end

    SDK->>AC: SDKResultMessage (success/error)
    AC-->>SM: AgentResult

    Note over SM: Extract response text<br/>Detect artifacts & email drafts

    SM->>Bot: Formatted response
    Bot->>Slack: Post Block Kit message<br/>(with execution summary)
    Slack-->>User: Display response

    Note over Bot: Check for new files<br/>in agent-output/
    opt New artifacts detected
        Bot->>Slack: Upload files to thread
    end
